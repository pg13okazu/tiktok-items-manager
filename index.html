<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TikTok ãƒãƒˆãƒ«ã‚¢ã‚¤ãƒ†ãƒ ç®¡ç†</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1976d2">

<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background: #f5f5f5;
    padding: 12px;
    margin: 0;
  }
  h2, h3 { margin: 12px 0 8px; }

  select, input, button {
    font-size: 16px;
    padding: 10px;
    margin: 6px 0;
    width: 100%;
    box-sizing: border-box;
  }

  button {
    background: #1976d2;
    color: white;
    border: none;
    border-radius: 8px;
  }

  button.danger { background: #d32f2f; }

  .card {
    background: white;
    padding: 14px;
    margin: 10px 0;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }

  .red { color: #d32f2f; font-weight: bold; }

  hr { margin: 16px 0; }

  .row {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
</style>
</head>
<body>

<h2>ğŸ“Š å…¨ä½“ã‚¢ã‚¤ãƒ†ãƒ æ•°</h2>
<div id="totalSummary" class="card"></div>

<h2>ğŸ‘¤ è¦–è´è€…ç®¡ç†</h2>
<div class="row">
  <select id="viewerSelect" onchange="render()"></select>
  <input id="viewerName" placeholder="è¦–è´è€…å">
  <button onclick="addViewer()">ï¼‹ è¦–è´è€…è¿½åŠ </button>
  <button class="danger" onclick="deleteViewer()">ğŸ—‘ è¦–è´è€…å‰Šé™¤</button>
</div>

<hr>

<h3>ğŸ® ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ </h3>
<div class="row">
  <select id="itemType">
    <option value="glove">ã‚°ãƒ­ãƒ¼ãƒ–</option>
    <option value="hammer">ãƒãƒ³ãƒãƒ¼</option>
    <option value="bonus">ãƒœãƒ¼ãƒŠã‚¹ã‚¿ã‚¤ãƒ </option>
    <option value="booster">ãƒ–ãƒ¼ã‚¹ã‚¿ãƒ¼</option>
    <option value="mist">ãƒŸã‚¹ãƒˆ</option>
  </select>
  <button onclick="addItem()">ï¼‹ ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ </button>
</div>

<hr>

<div id="items"></div>

<script>
/* ===== å®šæ•°ãƒ»ä¿å­˜ ===== */
const STORAGE_KEY = "tiktok_viewers";
const ITEM_LABELS = {
  glove: "ã‚°ãƒ­ãƒ¼ãƒ–",
  hammer: "ãƒãƒ³ãƒãƒ¼",
  bonus: "ãƒœãƒ¼ãƒŠã‚¹ã‚¿ã‚¤ãƒ ",
  booster: "ãƒ–ãƒ¼ã‚¹ã‚¿ãƒ¼",
  mist: "ãƒŸã‚¹ãƒˆ",
};

function load() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
}
function save(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function format(ms) {
  const d = Math.floor(ms / 86400000);
  const h = Math.floor(ms % 86400000 / 3600000);
  const m = Math.floor(ms % 3600000 / 60000);
  return `${d}æ—¥ ${h}æ™‚é–“ ${m}åˆ†`;
}

/* ===== è¦–è´è€… ===== */
function addViewer() {
  const name = viewerName.value.trim();
  if (!name) return;
  const data = load();
  const id = Date.now().toString();
  data[id] = { name, items: [] };
  save(data);
  viewerName.value = "";
  updateViewerList(id);
}

function deleteViewer() {
  const data = load();
  const vid = viewerSelect.value;
  if (!vid || !data[vid]) return;
  if (!confirm(`è¦–è´è€…ã€Œ${data[vid].name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\nå…¨ã‚¢ã‚¤ãƒ†ãƒ ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) return;
  delete data[vid];
  save(data);
  updateViewerList();
}

function updateViewerList(selectId) {
  const data = load();
  viewerSelect.innerHTML = "";
  for (const id in data) {
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = data[id].name;
    viewerSelect.appendChild(opt);
  }
  if (selectId) viewerSelect.value = selectId;
  render();
}

/* ===== ã‚¢ã‚¤ãƒ†ãƒ  ===== */
function addItem() {
  const vid = viewerSelect.value;
  if (!vid) return;
  const data = load();
  const now = Date.now();
  data[vid].items.push({
    type: itemType.value,
    acquiredAt: now,
    expiresAt: now + 120 * 60 * 60 * 1000,
  });
  save(data);
  render();
}

function consumeOldest(type) {
  const data = load();
  const vid = viewerSelect.value;
  if (!vid || !data[vid]) return;

  const targets = data[vid].items
    .map((item, index) => ({ item, index }))
    .filter(e => e.item.type === type);

  if (!targets.length) return;

  targets.sort((a, b) => a.item.expiresAt - b.item.expiresAt);

  if (!confirm(`${data[vid].name} ã®ã€Œ${ITEM_LABELS[type]}ã€ã‚’1ã¤æ¶ˆè²»ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  data[vid].items.splice(targets[0].index, 1);
  save(data);
  render();
}

/* ===== å…¨ä½“é›†è¨ˆ ===== */
function renderTotalSummary() {
  const data = load();
  const now = Date.now();
  const total = { glove:0, hammer:0, bonus:0, booster:0, mist:0 };

  for (const vid in data) {
    for (const item of data[vid].items) {
      if (item.expiresAt > now) total[item.type]++;
    }
  }

  totalSummary.innerHTML = `
    ${Object.keys(ITEM_LABELS).map(
      t => `${ITEM_LABELS[t]}ï¼š${total[t]}`
    ).join("<br>")}
  `;
}

/* ===== æç”» ===== */
function render() {
  const data = load();
  const vid = viewerSelect.value;
  if (!vid || !data[vid]) {
    renderTotalSummary();
    return;
  }

  const now = Date.now();
  data[vid].items = data[vid].items.filter(i => i.expiresAt > now);
  save(data);

  const grouped = {};
  for (const i of data[vid].items) {
    grouped[i.type] ??= [];
    grouped[i.type].push(i);
  }

  items.innerHTML = "";
  for (const type in ITEM_LABELS) {
    const arr = grouped[type] || [];
    if (!arr.length) continue;

    arr.sort((a,b) => a.expiresAt - b.expiresAt);
    const remain = arr[0].expiresAt - now;

    items.innerHTML += `
      <div class="card">
        <b>${ITEM_LABELS[type]}</b>ï¼š${arr.length}<br>
        <span class="${remain < 3600000 ? "red" : ""}">
          æœ€çŸ­æ¶ˆæ»…ã¾ã§ æ®‹ã‚Š ${format(remain)}
        </span><br><br>
        <button onclick="consumeOldest('${type}')">ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’1ã¤æ¶ˆè²»</button>
      </div>
    `;
  }

  renderTotalSummary();
}

/* ===== åˆæœŸåŒ– ===== */
setInterval(render, 60000);
updateViewerList();

/* ===== PWA ===== */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>

